<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.553">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="D. Scarnecchia">
<meta name="dcterms.date" content="2024-03-31">
<meta name="description" content="Documenting and benchmarking DuckDB for manipulating large datasets in the Sentinel Common Data Model.">
<title>musings.mountainherder.xyz - Manipulating Sentinel Data with DuckDB</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script type="application/json" class="js-hypothesis-config">
{
  "theme": "clean",
  "openSidebar": false
}
</script><script async="" src="https://hypothes.is/embed.js"></script><script>
  window.document.addEventListener("DOMContentLoaded", function (_event) {
    document.body.classList.add('hypothesis-enabled');
  });
</script><link rel="stylesheet" href="../../styles.css">
</head>
<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner"><nav class="navbar navbar-expand-lg " data-bs-theme="dark"><div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">musings.mountainherder.xyz</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
<li class="nav-item compact">
    <a class="nav-link" href="https://github.com/scarnecchia"> <i class="bi bi-github" role="img" aria-label="GitHub">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
</div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav></header><!-- content --><header id="title-block-header" class="quarto-title-block default page-columns page-full"><div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Manipulating Sentinel Data with DuckDB</h1>
                  <div>
        <div class="description">
          <p>Documenting and benchmarking DuckDB for manipulating large datasets in the Sentinel Common Data Model.</p>
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">duckdb</div>
                <div class="quarto-category">SAS</div>
                <div class="quarto-category">Sentinel</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>D. Scarnecchia </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">March 31, 2024</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        
    </div>
<!-- main -->
<main class="content quarto-banner-title-block page-columns page-full" id="quarto-document-content"><p>At work, we primarily work in SAS. This due to SAS as being a validated language and because of the large size of the data we work with. That said, this is 2024—SAS licenses are extremely expensive and the language is not nearly as flexible as open source offerings.</p>
<p>I generally prefer working in R, but one of the biggest challanges I’ve faced in using R at work is the fact that while SAS is able to handle data sets that are larger than memory by using a combination of fast disk I/O and memory management, R—like Python, natively prefers to manipulate datasets in memory. This is challenging when the datasets can be 100s of gigabytes in in question.</p>
<p>I’ve recently heard a lot of good things about <a href="https://duckdb.org">DuckDB</a> and been reading through <a href="https://bsky.app/profile/hrbrmstr.dev">@hrbrmstr’s</a> <a href="https://duckdb.hrbrmstr.app/">Cooking with DuckDB</a>. DuckDB is a relational database system designed for Online analytical processing (OLAP) workloads. It can be compiled with no external dependencies—incredibly useful for embedded applications—and is known for its ability to query large databases very quickly. I decided to give it a try. This post is intended to do some basic benchmarking against data in the <a href="https://www.sentinelinitiative.org/methods-data-tools/sentinel-common-data-model">Sentinel Common Data Model</a> (SCDM). It has R, Python, and Rust APIs, which will make it incredibly useful for querying large datasets from these languages.</p>
<div class="page-columns page-full"><p></p><div class="no-row-height column-margin column-container"><span class="margin-aside">I am aware of arrow and pola.rs. I will eventually benchmark these versus duckDB.</span></div></div>
<div class="callout callout-style-simple callout-note no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p>All SAS queries were run on a Dell PowerEdge R750 Rack Server dedicated to running SAS 9.4M5 with an Intel Xeon 6134 Gold processor and 8 CPUs with 8 cores apiece running at 3.20 Ghz and sporting 1.5 TB of RAM. All R and DuckDB queries were run a MacBook Pro with the following stats:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Memory: 16 GB
Chip: Apple M3
Total Number of Cores: 8 (4 performance and 4 efficiency)</code></pre>
</div>
</div>
</div>
</div>
</div>
<section id="getting-started" class="level2"><h2 class="anchored" data-anchor-id="getting-started">Getting Started</h2>
<p>While it’s not nearly as large as the data our Data Partners hold or our internal test data, the <a href="https://www.sentinelinitiative.org/methods-data-tools/software-packages-toolkits/medicare-claims-synthetic-public-use-files-sentinel-0">CMS 2008-2010 Data Entrepreneurs’ Synthetic Public Use Files (SynPUFs)</a> are publically available synthetic data in the Sentinel Common Data Model (SCDM) format, able to be used publicly, and still of a decent size. The SynPUFs are 5% synthetic samples of Medicare claims data from 2008 to 2010 and consist of 20, mutually exclusive datasets in the SAS7BDAT format.</p>
<p>The first challenge is that these datasets are large—e.g., the diagnosis table consists of twenty 810 MB .SAS7BDAT format files. As SAS7BDAT is a propriety format and I don’t have a SAS license on my home machine, I needed to convert these files to a format that DuckDB could read. The haven library offers <code>read_sas()</code>, but it requires holding the data in memory, and with 16 Gb of RAM on my MBP, binding the the subsamples for the largest datasets together and writing to parquet was a non-starter.</p>
<p>Fortunately, thanks to R’s purrr(), I was able to devise an inelegant solution<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>. I didn’t bother benchmarking this step, but it took roughly an hour on the MBP to chew through all of the datasets, appending each partition to a DuckDB table one-by-one, and then writing to parquet. <a href="#lst-sas-parquet" class="quarto-xref">Listing&nbsp;1</a> shows the code used for this.</p>
<div class="cell">
<div id="lst-sas-parquet" class="r cell-code listing quarto-float" data-code-fold="true">
<figure class="quarto-float quarto-float-lst figure"><figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-lst" id="lst-sas-parquet-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Listing&nbsp;1: R code for extracting SAS datasets and converting to parquet
</figcaption><div aria-describedby="lst-sas-parquet-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="sourceCode" id="lst-sas-parquet" data-code-fold="true"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">tables</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"death"</span>, <span class="st">"demographic"</span>, <span class="st">"diagnosis"</span>, <span class="st">"dispensing"</span>, <span class="st">"encounter"</span>, <span class="st">"enrollment"</span>,</span>
<span>    <span class="st">"procedure"</span>, <span class="st">"facility"</span>, <span class="st">"provider"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">con</span> <span class="op">&lt;-</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbConnect.html">dbConnect</a></span><span class="op">(</span><span class="fu">duckdb</span><span class="fu">::</span><span class="fu"><a href="https://r.duckdb.org/reference/duckdb.html">duckdb</a></span><span class="op">(</span>dbdir <span class="op">=</span> <span class="st">"~/dev/SynPUFsDuckDB/data/duckdb.duckdb"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">walk</a></span><span class="op">(</span><span class="va">tables</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>    <span class="va">data</span> <span class="op">&lt;-</span> <span class="fu">haven</span><span class="fu">::</span><span class="fu">read_sas</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"data/"</span>, <span class="va">x</span>, <span class="st">"_1"</span>, <span class="st">".sas7bdat"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>    <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbExecute.html">dbExecute</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"drop table if exists data"</span><span class="op">)</span></span>
<span>    <span class="fu">duckdb</span><span class="fu">::</span><span class="fu">dbWriteTable</span><span class="op">(</span><span class="va">con</span>, <span class="st">"data"</span>, <span class="va">data</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">num</span> <span class="op">&lt;-</span> <span class="fl">2</span><span class="op">:</span><span class="fl">20</span></span>
<span></span>
<span>    <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">walk</a></span><span class="op">(</span><span class="va">num</span>, <span class="kw">function</span><span class="op">(</span><span class="va">y</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">data</span> <span class="op">&lt;-</span> <span class="fu">haven</span><span class="fu">::</span><span class="fu">read_sas</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"data/"</span>, <span class="va">x</span>, <span class="st">"_"</span>, <span class="va">y</span>, <span class="st">".sas7bdat"</span><span class="op">)</span><span class="op">)</span></span>
<span>        <span class="fu">duckdb</span><span class="fu">::</span><span class="fu">dbAppendTable</span><span class="op">(</span><span class="va">con</span>, <span class="st">"data"</span>, <span class="va">data</span><span class="op">)</span></span>
<span>    <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span>    <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbExecute.html">dbExecute</a></span><span class="op">(</span><span class="va">con</span>, <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"copy data to '~/dev/SynPUFsDuckDB/data/%s-snappy.parquet' (format 'parquet');"</span>,</span>
<span>        <span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbExecute.html">dbExecute</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"drop table if exists data"</span><span class="op">)</span></span>
<span><span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbDisconnect.html">dbDisconnect</a></span><span class="op">(</span><span class="va">con</span>, shutdown <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</figure>
</div>
</div>
<p>Now that we have that data in a more usable format. Let’s look at what we have. I’ll start by summarizing the tables. DuckDB’s summarize feature is useful, but overkill here, so we’re going simply going to describe the tables.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist">
<li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" role="tab" aria-controls="tabset-1-1" aria-selected="true">ENR</a></li>
<li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" role="tab" aria-controls="tabset-1-2" aria-selected="false">DEM</a></li>
<li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-3" role="tab" aria-controls="tabset-1-3" aria-selected="false">DIS</a></li>
<li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-4-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-4" role="tab" aria-controls="tabset-1-4" aria-selected="false">ENC</a></li>
<li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-5-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-5" role="tab" aria-controls="tabset-1-5" aria-selected="false">DIA</a></li>
<li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-6-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-6" role="tab" aria-controls="tabset-1-6" aria-selected="false">PRO</a></li>
<li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-7-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-7" role="tab" aria-controls="tabset-1-7" aria-selected="false">DTH</a></li>
<li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-8-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-8" role="tab" aria-controls="tabset-1-8" aria-selected="false">FAC</a></li>
<li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-9-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-9" role="tab" aria-controls="tabset-1-9" aria-selected="false">PVD</a></li>
</ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-1-1-tab">
<div class="cell" data-tbl-label="tbl-describe-enr" data-tbl-caption="Description of the Enrollment Table">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="bu">time</span> /opt/homebrew/bin/duckdb duckdb.duckdb <span class="at">-markdown</span> <span class="at">-c</span> <span class="st">"</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="st">  DESCRIBE SELECT *</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="st">  FROM '~/dev/SynPUFsDuckDB/data/enrollment-snappy.parquet';"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<table class="table table-sm table-striped small">
<thead><tr class="header">
<th>column_name</th>
<th>column_type</th>
<th>null</th>
<th>key</th>
<th>default</th>
<th>extra</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>PatID</td>
<td>UBIGINT</td>
<td>YES</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>Enr_Start</td>
<td>DATE</td>
<td>YES</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>Enr_End</td>
<td>DATE</td>
<td>YES</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>MedCov</td>
<td>VARCHAR</td>
<td>YES</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>DrugCov</td>
<td>VARCHAR</td>
<td>YES</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>Chart</td>
<td>VARCHAR</td>
<td>YES</td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>real 0m0.012s user 0m0.008s sys 0m0.002s</p>
</div>
</div>
<div id="tabset-1-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-2-tab">
<div class="cell" data-tbl-label="tbl-describe-dem" data-tbl-caption="Description of the Demographic Table">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="bu">time</span> /opt/homebrew/bin/duckdb duckdb.duckdb <span class="at">-markdown</span> <span class="at">-c</span> <span class="st">"</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="st">  DESCRIBE SELECT *</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="st">  FROM '~/dev/SynPUFsDuckDB/data/demographic-snappy.parquet';"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<table class="table table-sm table-striped small">
<thead><tr class="header">
<th>column_name</th>
<th>column_type</th>
<th>null</th>
<th>key</th>
<th>default</th>
<th>extra</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>PatID</td>
<td>UBIGINT</td>
<td>YES</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>Birth_date</td>
<td>DATE</td>
<td>YES</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>Sex</td>
<td>VARCHAR</td>
<td>YES</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>Hispanic</td>
<td>VARCHAR</td>
<td>YES</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>Race</td>
<td>VARCHAR</td>
<td>YES</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>PostalCode</td>
<td>VARCHAR</td>
<td>YES</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>PostalCode_date</td>
<td>DATE</td>
<td>YES</td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>real 0m0.011s user 0m0.007s sys 0m0.002s</p>
</div>
</div>
<div id="tabset-1-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-3-tab">
<div class="cell" data-tbl-label="tbl-describe-dis" data-tbl-caption="Description of the Dispensing Table">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="bu">time</span> /opt/homebrew/bin/duckdb duckdb.duckdb <span class="at">-markdown</span> <span class="at">-c</span> <span class="st">"</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="st">  DESCRIBE SELECT *</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="st">  FROM '~/dev/SynPUFsDuckDB/data/dispensing-snappy.parquet';"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<table class="table table-sm table-striped small">
<thead><tr class="header">
<th>column_name</th>
<th>column_type</th>
<th>null</th>
<th>key</th>
<th>default</th>
<th>extra</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>PatID</td>
<td>UBIGINT</td>
<td>YES</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>ProviderID</td>
<td>UBIGINT</td>
<td>YES</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>RxDate</td>
<td>DATE</td>
<td>YES</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>Rx</td>
<td>VARCHAR</td>
<td>YES</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>Rx_CodeType</td>
<td>VARCHAR</td>
<td>YES</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>RxSup</td>
<td>UINTEGER</td>
<td>YES</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>RxAmt</td>
<td>UINTEGER</td>
<td>YES</td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>real 0m0.016s user 0m0.012s sys 0m0.002s</p>
</div>
</div>
<div id="tabset-1-4" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-4-tab">
<div class="cell" data-tbl-label="tbl-describe-enc" data-tbl-caption="Description of the Encounter Table">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="bu">time</span> /opt/homebrew/bin/duckdb duckdb.duckdb <span class="at">-markdown</span> <span class="at">-c</span> <span class="st">"</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="st">  DESCRIBE SELECT *</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="st">  FROM '~/dev/SynPUFsDuckDB/data/encounter-snappy.parquet';"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<table class="table table-sm table-striped small">
<thead><tr class="header">
<th>column_name</th>
<th>column_type</th>
<th>null</th>
<th>key</th>
<th>default</th>
<th>extra</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>PatID</td>
<td>UBIGINT</td>
<td>YES</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>EncounterID</td>
<td>UBIGINT</td>
<td>YES</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>ADate</td>
<td>DATE</td>
<td>YES</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>DDate</td>
<td>DATE</td>
<td>YES</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>EncType</td>
<td>VARCHAR</td>
<td>YES</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>FacilityID</td>
<td>UBIGINT</td>
<td>YES</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>Discharge_Disposition</td>
<td>VARCHAR</td>
<td>YES</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>Discharge_Status</td>
<td>VARCHAR</td>
<td>YES</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>DRG</td>
<td>VARCHAR</td>
<td>YES</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>DRG_Type</td>
<td>VARCHAR</td>
<td>YES</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>Admitting_Source</td>
<td>VARCHAR</td>
<td>YES</td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>real 0m0.019s user 0m0.016s sys 0m0.002s</p>
</div>
</div>
<div id="tabset-1-5" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-5-tab">
<div class="cell" data-tbl-label="tbl-describe-dia" data-tbl-caption="Description of the Diagnosis Table">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="bu">time</span> /opt/homebrew/bin/duckdb duckdb.duckdb <span class="at">-markdown</span> <span class="at">-c</span> <span class="st">"</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="st">  DESCRIBE SELECT *</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="st">  FROM '~/dev/SynPUFsDuckDB/data/diagnosis-snappy.parquet';"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<table class="table table-sm table-striped small">
<thead><tr class="header">
<th>column_name</th>
<th>column_type</th>
<th>null</th>
<th>key</th>
<th>default</th>
<th>extra</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>PatID</td>
<td>UBIGINT</td>
<td>YES</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>EncounterID</td>
<td>UBIGINT</td>
<td>YES</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>ADate</td>
<td>DATE</td>
<td>YES</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>ProviderID</td>
<td>UBIGINT</td>
<td>YES</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>EncType</td>
<td>VARCHAR</td>
<td>YES</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>DX</td>
<td>VARCHAR</td>
<td>YES</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>DX_codetype</td>
<td>VARCHAR</td>
<td>YES</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>OrigDX</td>
<td>VARCHAR</td>
<td>YES</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>PDX</td>
<td>VARCHAR</td>
<td>YES</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>PAdmit</td>
<td>VARCHAR</td>
<td>YES</td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>real 0m0.040s user 0m0.034s sys 0m0.004s</p>
</div>
</div>
<div id="tabset-1-6" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-6-tab">
<div class="cell" data-tbl-label="tbl-describe-pro" data-tbl-caption="Description of the Procedure Table">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="bu">time</span> /opt/homebrew/bin/duckdb duckdb.duckdb <span class="at">-markdown</span> <span class="at">-c</span> <span class="st">"</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="st">  DESCRIBE SELECT *</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="st">  FROM '~/dev/SynPUFsDuckDB/data/procedure-snappy.parquet';"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<table class="table table-sm table-striped small">
<thead><tr class="header">
<th>column_name</th>
<th>column_type</th>
<th>null</th>
<th>key</th>
<th>default</th>
<th>extra</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>PatID</td>
<td>UBIGINT</td>
<td>YES</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>EncounterID</td>
<td>UBIGINT</td>
<td>YES</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>ADate</td>
<td>DATE</td>
<td>YES</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>ProviderID</td>
<td>UBIGINT</td>
<td>YES</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>EncType</td>
<td>VARCHAR</td>
<td>YES</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>PX</td>
<td>VARCHAR</td>
<td>YES</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>PX_codetype</td>
<td>VARCHAR</td>
<td>YES</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>OrigPX</td>
<td>VARCHAR</td>
<td>YES</td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>real 0m0.026s user 0m0.021s sys 0m0.003s</p>
</div>
</div>
<div id="tabset-1-7" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-7-tab">
<div class="cell" data-tbl-label="tbl-describe-dth" data-tbl-caption="Description of the Death Table">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="bu">time</span> /opt/homebrew/bin/duckdb duckdb.duckdb <span class="at">-markdown</span> <span class="at">-c</span> <span class="st">"</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="st">  DESCRIBE SELECT *</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="st">  FROM '~/dev/SynPUFsDuckDB/data/death-snappy.parquet';"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<table class="table table-sm table-striped small">
<thead><tr class="header">
<th>column_name</th>
<th>column_type</th>
<th>null</th>
<th>key</th>
<th>default</th>
<th>extra</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>PatID</td>
<td>UBIGINT</td>
<td>YES</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>DeathDt</td>
<td>DATE</td>
<td>YES</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>DtImpute</td>
<td>VARCHAR</td>
<td>YES</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>Source</td>
<td>VARCHAR</td>
<td>YES</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>Confidence</td>
<td>VARCHAR</td>
<td>YES</td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>real 0m0.011s user 0m0.007s sys 0m0.002s</p>
</div>
</div>
<div id="tabset-1-8" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-8-tab">
<div class="cell" data-tbl-label="tbl-describe-fac" data-tbl-caption="Description of the Facility Table">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="bu">time</span> /opt/homebrew/bin/duckdb duckdb.duckdb <span class="at">-markdown</span> <span class="at">-c</span> <span class="st">"</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="st">  DESCRIBE SELECT *</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="st">  FROM '~/dev/SynPUFsDuckDB/data/facility-snappy.parquet';"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<table class="table table-sm table-striped small">
<thead><tr class="header">
<th>column_name</th>
<th>column_type</th>
<th>null</th>
<th>key</th>
<th>default</th>
<th>extra</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>FacilityID</td>
<td>UBIGINT</td>
<td>YES</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>Facility_Location</td>
<td>VARCHAR</td>
<td>YES</td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>real 0m0.010s user 0m0.007s sys 0m0.002s</p>
</div>
</div>
<div id="tabset-1-9" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-9-tab">
<div class="cell" data-tbl-label="tbl-describe-pvd" data-tbl-caption="Description of the Provider Table">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="bu">time</span> /opt/homebrew/bin/duckdb duckdb.duckdb <span class="at">-markdown</span> <span class="at">-c</span> <span class="st">"</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="st">  DESCRIBE SELECT *</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="st">  FROM '~/dev/SynPUFsDuckDB/data/provider-snappy.parquet';"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<table class="table table-sm table-striped small">
<thead><tr class="header">
<th>column_name</th>
<th>column_type</th>
<th>null</th>
<th>key</th>
<th>default</th>
<th>extra</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>ProviderID</td>
<td>UBIGINT</td>
<td>YES</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>Specialty</td>
<td>VARCHAR</td>
<td>YES</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>Specialty_CodeType</td>
<td>VARCHAR</td>
<td>YES</td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>real 0m0.011s user 0m0.007s sys 0m0.002s</p>
</div>
</div>
</div>
</div>
<p>On initial challenge: as R doesn’t natively have a 8-byte (64-bit) numeric type, it coerced any column that was an integer larger than 8-bytes to a double. I didn’t want to take the chance of out of memory errors to work with these as a dataframe, so I used DuckDB to alter the type. <code>UBIGINT</code> is DuckDB’s unsigned 8-byte integer type.</p>
<p>Let’s count grab the number of records in each parquet file and unioning them together:</p>
<div class="cell" data-tbl-label="tbl-dx-count" data-tbl-caption="Count of Records, Diagnosis Table">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="bu">time</span> /opt/homebrew/bin/duckdb duckdb.duckdb <span class="at">-markdown</span> <span class="at">-c</span> <span class="st">"</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="st">  SELECT format('Enrollment') as Table</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="st">       , count(*) as count</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="st">  FROM '~/dev/SynPUFsDuckDB/data/enrollment-snappy.parquet'</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="st">  UNION</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="st">  SELECT format('Demographic') as Table</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="st">       , count(*) as count</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="st">  FROM '~/dev/SynPUFsDuckDB/data/demographic-snappy.parquet'</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="st">  UNION</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="st">  SELECT format('Dispensing') as Table</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="st">       , count(*) as count</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="st">  FROM '~/dev/SynPUFsDuckDB/data/dispensing-snappy.parquet'</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a><span class="st">  UNION</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a><span class="st">  SELECT format('Encounter') as Table</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a><span class="st">       , count(*) as count</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a><span class="st">  FROM '~/dev/SynPUFsDuckDB/data/encounter-snappy.parquet'</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a><span class="st">  UNION</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a><span class="st">  SELECT format('Diagnosis') as Table</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a><span class="st">       , count(*) as count</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a><span class="st">  FROM '~/dev/SynPUFsDuckDB/data/diagnosis-snappy.parquet'</span></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a><span class="st">  UNION</span></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a><span class="st">  SELECT format('Procedure') as Table</span></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a><span class="st">       , count(*) as count</span></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a><span class="st">  FROM '~/dev/SynPUFsDuckDB/data/procedure-snappy.parquet'</span></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a><span class="st">  UNION</span></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a><span class="st">  SELECT format('Death') as Table</span></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a><span class="st">       , count(*) as count</span></span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a><span class="st">  FROM '~/dev/SynPUFsDuckDB/data/death-snappy.parquet'</span></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a><span class="st">  UNION</span></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a><span class="st">  SELECT format('Facility') as Table</span></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a><span class="st">       , count(*) as count</span></span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a><span class="st">  FROM '~/dev/SynPUFsDuckDB/data/facility-snappy.parquet'</span></span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a><span class="st">  UNION</span></span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a><span class="st">  SELECT format('Provider') as Table</span></span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a><span class="st">       , count(*) as count</span></span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a><span class="st">  FROM '~/dev/SynPUFsDuckDB/data/provider-snappy.parquet'</span></span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a><span class="st">  ;"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<table class="table table-sm table-striped small">
<thead><tr class="header">
<th>Table</th>
<th style="text-align: right;">count</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Death</td>
<td style="text-align: right;">98152</td>
</tr>
<tr class="even">
<td>Demographic</td>
<td style="text-align: right;">2224739</td>
</tr>
<tr class="odd">
<td>Provider</td>
<td style="text-align: right;">12803343</td>
</tr>
<tr class="even">
<td>Facility</td>
<td style="text-align: right;">53686</td>
</tr>
<tr class="odd">
<td>Encounter</td>
<td style="text-align: right;">111738882</td>
</tr>
<tr class="even">
<td>Dispensing</td>
<td style="text-align: right;">111085327</td>
</tr>
<tr class="odd">
<td>Enrollment</td>
<td style="text-align: right;">3668891</td>
</tr>
<tr class="even">
<td>Diagnosis</td>
<td style="text-align: right;">352441529</td>
</tr>
<tr class="odd">
<td>Procedure</td>
<td style="text-align: right;">222919598</td>
</tr>
</tbody>
</table>
<p>real 0m0.129s user 0m0.185s sys 0m0.025s</p>
</div>
</section><section id="querying-the-data" class="level2"><h2 class="anchored" data-anchor-id="querying-the-data">Querying the Data</h2>
<p>As I explored DuckDB, I ran a number of different SQL queries—some of which had practical purposes, others which were essentially cursed—as I attempted to put the tool through its passes. I was consistently impressed by the speed at which it returned answers. I decided to start with a relatively simple query of some practical use. <a href="#lst-dem-l3-agecat-catvars-sas" class="quarto-xref">Listing&nbsp;2</a> illustrates SAS code which does the following:</p>
<ol type="1">
<li>Create a SAS format which bins ages into age cohorts</li>
<li>Calculates age as of the maximum date of the data—2010-12-31, stratifies by Sex, Ethnicity, and Race, and counts the number of records of a given age.</li>
<li>Applies the label and re-aggregates count.</li>
<li>Removes Sex, Ethnicity, and Race from the dataset, and re-aggregates the count.</li>
</ol>
<p>For reference, the demographic table is smaller than the diagnosis table with:</p>
<div id="lst-dem-l3-agecat-catvars-sas" class="listing quarto-float">
<figure class="quarto-float quarto-float-lst figure"><figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-lst" id="lst-dem-l3-agecat-catvars-sas-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Listing&nbsp;2: Calulate age cohorts and aggregate the demographic table by age cohort and demographic characteristics.
</figcaption><div aria-describedby="lst-dem-l3-agecat-catvars-sas-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<pre id="lst-dem-l3-agecat-catvars-sas"><code>libname synpufs "/path/obscured/SynPUFsDuckDB/data/";

proc format;
  value agecat_years
  .       = "00. Missing"
  low-&lt;0  = "00. Negative"
  0-&lt;2    = "01. 0-1 yrs"
  2-&lt;5    = "02. 2-4 yrs"
  5-&lt;10   = "03. 5-9 yrs"
  10-&lt;15  = "04. 10-14 yrs"
  15-&lt;19  = "05. 15-18 yrs"
  19-&lt;22  = "06. 19-21 yrs"
  22-&lt;25  = "07. 22-24 yrs"
  25-&lt;35 = "08. 25-34 yrs"
  35-&lt;45 = "09. 35-44 yrs"
  45-&lt;55 = "10. 45-54 yrs"
  55-&lt;60 = "11. 55-59 yrs"
  60-&lt;65 = "12. 60-64 yrs"
  65-&lt;70 = "13. 65-69 yrs"
  70-&lt;75 = "14. 70-74 yrs"
  75-high = "15. 75+ yrs"
  ;
run;

proc sql noprint;
create table _dem_l2_age as
select floor((intck("month",birth_date,"31Dec2010"d)-(day("31Dec2010"d)&lt;day(birth_date)))/12) as age_years label="Age (Years)"
     ,  sex
     ,  hispanic
     ,  race
     ,  count(*) as count format=comma16.
from synpufs.demographic
group by calculated age_years, sex, hispanic, race;
quit;

proc sql noprint;
     create table dem_l2_agecat_catvars as
     select put(age_years,agecat_years.) as agecat_years label="Age Category (Years)"
     ,  sex
     ,  hispanic
     ,  race
     ,  sum(count) as count format=comma16.
     from _dem_l2_age
     group by calculated agecat_years, sex, hispanic, race
     order by calculated agecat_years;
quit;

proc sql noprint;
     create table dem_l2_agecat as
     select agecat_years
     ,  sum(count) as count format=comma16.
     from dem_l2_agecat_catvars
     group by agecat_years;
quit;</code></pre>
</div>
</figure>
</div>
<p>I called this on the SAS Server via the CLI with time, and got the following results:</p>
<pre><code>real    0m5.178s
user    0m1.871s
sys     0m0.153s</code></pre>
<p>Now let’s run the same query via DuckDB in the command line—note the time below <a href="#lst-dem-l3-agecat-catvars" class="quarto-xref">Listing&nbsp;3</a>.</p>
<div class="cell">
<div id="lst-dem-l3-agecat-catvars" class="bash cell-code listing quarto-float">
<figure class="quarto-float quarto-float-lst figure"><figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-lst" id="lst-dem-l3-agecat-catvars-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Listing&nbsp;3: Calulate age cohorts and aggregate the demographic table by age cohort and demographic characteristics.
</figcaption><div aria-describedby="lst-dem-l3-agecat-catvars-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="sourceCode cell-code" id="lst-dem-l3-agecat-catvars"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="lst-dem-l3-agecat-catvars-1"><a href="#lst-dem-l3-agecat-catvars-1" aria-hidden="true" tabindex="-1"></a><span class="bu">time</span> /opt/homebrew/bin/duckdb duckdb.duckdb <span class="at">-markdown</span> <span class="at">-c</span> <span class="st">"</span></span>
<span id="lst-dem-l3-agecat-catvars-2"><a href="#lst-dem-l3-agecat-catvars-2" aria-hidden="true" tabindex="-1"></a><span class="st">CREATE OR REPLACE TEMP TABLE dem_l3_tmp AS</span></span>
<span id="lst-dem-l3-agecat-catvars-3"><a href="#lst-dem-l3-agecat-catvars-3" aria-hidden="true" tabindex="-1"></a><span class="st">SELECT (CAST(FLOOR(CAST(DATESUB('month', Birth_date, '2010-12-31') AS INTEGER) / 12) AS INTEGER)) as age</span></span>
<span id="lst-dem-l3-agecat-catvars-4"><a href="#lst-dem-l3-agecat-catvars-4" aria-hidden="true" tabindex="-1"></a><span class="st">      , sex</span></span>
<span id="lst-dem-l3-agecat-catvars-5"><a href="#lst-dem-l3-agecat-catvars-5" aria-hidden="true" tabindex="-1"></a><span class="st">      , hispanic</span></span>
<span id="lst-dem-l3-agecat-catvars-6"><a href="#lst-dem-l3-agecat-catvars-6" aria-hidden="true" tabindex="-1"></a><span class="st">      , race</span></span>
<span id="lst-dem-l3-agecat-catvars-7"><a href="#lst-dem-l3-agecat-catvars-7" aria-hidden="true" tabindex="-1"></a><span class="st">      , count(*) as count</span></span>
<span id="lst-dem-l3-agecat-catvars-8"><a href="#lst-dem-l3-agecat-catvars-8" aria-hidden="true" tabindex="-1"></a><span class="st">FROM '~/dev/SynPUFsDuckDB/data/demographic-snappy.parquet'</span></span>
<span id="lst-dem-l3-agecat-catvars-9"><a href="#lst-dem-l3-agecat-catvars-9" aria-hidden="true" tabindex="-1"></a><span class="st">GROUP BY age, sex, hispanic, race;</span></span>
<span id="lst-dem-l3-agecat-catvars-10"><a href="#lst-dem-l3-agecat-catvars-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-dem-l3-agecat-catvars-11"><a href="#lst-dem-l3-agecat-catvars-11" aria-hidden="true" tabindex="-1"></a><span class="st">CREATE OR REPLACE TEMP TABLE dem_l3_agecat_catvars AS</span></span>
<span id="lst-dem-l3-agecat-catvars-12"><a href="#lst-dem-l3-agecat-catvars-12" aria-hidden="true" tabindex="-1"></a><span class="st">SELECT CASE WHEN age IS NULL THEN '00. MISSING'</span></span>
<span id="lst-dem-l3-agecat-catvars-13"><a href="#lst-dem-l3-agecat-catvars-13" aria-hidden="true" tabindex="-1"></a><span class="st">            WHEN age &lt; 0 THEN '00. NEGATIVE'</span></span>
<span id="lst-dem-l3-agecat-catvars-14"><a href="#lst-dem-l3-agecat-catvars-14" aria-hidden="true" tabindex="-1"></a><span class="st">            WHEN AGE BETWEEN 2 AND 4   THEN '02. 2-4 yrs'</span></span>
<span id="lst-dem-l3-agecat-catvars-15"><a href="#lst-dem-l3-agecat-catvars-15" aria-hidden="true" tabindex="-1"></a><span class="st">            WHEN AGE BETWEEN 5 AND 9  THEN '03. 5-9 yrs'</span></span>
<span id="lst-dem-l3-agecat-catvars-16"><a href="#lst-dem-l3-agecat-catvars-16" aria-hidden="true" tabindex="-1"></a><span class="st">            WHEN AGE BETWEEN 10 AND 14 THEN '04. 10-14 yrs'</span></span>
<span id="lst-dem-l3-agecat-catvars-17"><a href="#lst-dem-l3-agecat-catvars-17" aria-hidden="true" tabindex="-1"></a><span class="st">            WHEN AGE BETWEEN 15 AND 18 THEN '05. 15-18 yrs'</span></span>
<span id="lst-dem-l3-agecat-catvars-18"><a href="#lst-dem-l3-agecat-catvars-18" aria-hidden="true" tabindex="-1"></a><span class="st">            WHEN AGE BETWEEN 19 AND 21 THEN '06. 19-21 yrs'</span></span>
<span id="lst-dem-l3-agecat-catvars-19"><a href="#lst-dem-l3-agecat-catvars-19" aria-hidden="true" tabindex="-1"></a><span class="st">            WHEN AGE BETWEEN 22 AND 24 THEN '07. 22-24 yrs'</span></span>
<span id="lst-dem-l3-agecat-catvars-20"><a href="#lst-dem-l3-agecat-catvars-20" aria-hidden="true" tabindex="-1"></a><span class="st">            WHEN AGE BETWEEN 25 AND 34 THEN '08. 25-34 yrs'</span></span>
<span id="lst-dem-l3-agecat-catvars-21"><a href="#lst-dem-l3-agecat-catvars-21" aria-hidden="true" tabindex="-1"></a><span class="st">            WHEN AGE BETWEEN 35 AND 44 THEN '09. 35-44 yrs'</span></span>
<span id="lst-dem-l3-agecat-catvars-22"><a href="#lst-dem-l3-agecat-catvars-22" aria-hidden="true" tabindex="-1"></a><span class="st">            WHEN AGE BETWEEN 45 AND 54 THEN '10. 45-54 yrs'</span></span>
<span id="lst-dem-l3-agecat-catvars-23"><a href="#lst-dem-l3-agecat-catvars-23" aria-hidden="true" tabindex="-1"></a><span class="st">            WHEN AGE BETWEEN 55 AND 59 THEN '11. 55-59 yrs'</span></span>
<span id="lst-dem-l3-agecat-catvars-24"><a href="#lst-dem-l3-agecat-catvars-24" aria-hidden="true" tabindex="-1"></a><span class="st">            WHEN AGE BETWEEN 60 AND 64 THEN '12. 60-64 yrs'</span></span>
<span id="lst-dem-l3-agecat-catvars-25"><a href="#lst-dem-l3-agecat-catvars-25" aria-hidden="true" tabindex="-1"></a><span class="st">            WHEN AGE BETWEEN 65 AND 69 THEN '13. 65-69 yrs'</span></span>
<span id="lst-dem-l3-agecat-catvars-26"><a href="#lst-dem-l3-agecat-catvars-26" aria-hidden="true" tabindex="-1"></a><span class="st">            WHEN AGE BETWEEN 70 AND 74 THEN '14. 70-74 yrs'</span></span>
<span id="lst-dem-l3-agecat-catvars-27"><a href="#lst-dem-l3-agecat-catvars-27" aria-hidden="true" tabindex="-1"></a><span class="st">            ELSE '15. 75+' END as agecat_years</span></span>
<span id="lst-dem-l3-agecat-catvars-28"><a href="#lst-dem-l3-agecat-catvars-28" aria-hidden="true" tabindex="-1"></a><span class="st">     , sex</span></span>
<span id="lst-dem-l3-agecat-catvars-29"><a href="#lst-dem-l3-agecat-catvars-29" aria-hidden="true" tabindex="-1"></a><span class="st">     , hispanic</span></span>
<span id="lst-dem-l3-agecat-catvars-30"><a href="#lst-dem-l3-agecat-catvars-30" aria-hidden="true" tabindex="-1"></a><span class="st">     , race</span></span>
<span id="lst-dem-l3-agecat-catvars-31"><a href="#lst-dem-l3-agecat-catvars-31" aria-hidden="true" tabindex="-1"></a><span class="st">     , sum(count) as count</span></span>
<span id="lst-dem-l3-agecat-catvars-32"><a href="#lst-dem-l3-agecat-catvars-32" aria-hidden="true" tabindex="-1"></a><span class="st">FROM dem_l3_tmp</span></span>
<span id="lst-dem-l3-agecat-catvars-33"><a href="#lst-dem-l3-agecat-catvars-33" aria-hidden="true" tabindex="-1"></a><span class="st">GROUP BY agecat_years, sex, hispanic, race</span></span>
<span id="lst-dem-l3-agecat-catvars-34"><a href="#lst-dem-l3-agecat-catvars-34" aria-hidden="true" tabindex="-1"></a><span class="st">ORDER BY agecat_years;</span></span>
<span id="lst-dem-l3-agecat-catvars-35"><a href="#lst-dem-l3-agecat-catvars-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-dem-l3-agecat-catvars-36"><a href="#lst-dem-l3-agecat-catvars-36" aria-hidden="true" tabindex="-1"></a><span class="st">CREATE OR REPLACE TABLE dem_l3_agecat AS</span></span>
<span id="lst-dem-l3-agecat-catvars-37"><a href="#lst-dem-l3-agecat-catvars-37" aria-hidden="true" tabindex="-1"></a><span class="st">  SELECT</span></span>
<span id="lst-dem-l3-agecat-catvars-38"><a href="#lst-dem-l3-agecat-catvars-38" aria-hidden="true" tabindex="-1"></a><span class="st">    agecat_years,</span></span>
<span id="lst-dem-l3-agecat-catvars-39"><a href="#lst-dem-l3-agecat-catvars-39" aria-hidden="true" tabindex="-1"></a><span class="st">    SUM(count) AS count</span></span>
<span id="lst-dem-l3-agecat-catvars-40"><a href="#lst-dem-l3-agecat-catvars-40" aria-hidden="true" tabindex="-1"></a><span class="st">  FROM</span></span>
<span id="lst-dem-l3-agecat-catvars-41"><a href="#lst-dem-l3-agecat-catvars-41" aria-hidden="true" tabindex="-1"></a><span class="st">    dem_l3_agecat_catvars</span></span>
<span id="lst-dem-l3-agecat-catvars-42"><a href="#lst-dem-l3-agecat-catvars-42" aria-hidden="true" tabindex="-1"></a><span class="st">  GROUP BY</span></span>
<span id="lst-dem-l3-agecat-catvars-43"><a href="#lst-dem-l3-agecat-catvars-43" aria-hidden="true" tabindex="-1"></a><span class="st">    agecat_years</span></span>
<span id="lst-dem-l3-agecat-catvars-44"><a href="#lst-dem-l3-agecat-catvars-44" aria-hidden="true" tabindex="-1"></a><span class="st">  ORDER BY</span></span>
<span id="lst-dem-l3-agecat-catvars-45"><a href="#lst-dem-l3-agecat-catvars-45" aria-hidden="true" tabindex="-1"></a><span class="st">    agecat_years;</span></span>
<span id="lst-dem-l3-agecat-catvars-46"><a href="#lst-dem-l3-agecat-catvars-46" aria-hidden="true" tabindex="-1"></a><span class="st">"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</figure>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
real    0m0.059s
user    0m0.283s
sys 0m0.012s</code></pre>
</div>
</div>
<p>As you can see, this results in a runtime that is two orders of magnitude faster than SAS.</p>
<p>Now, for the sake of completeness, let’s compare the results. We’ll see that they’re identical.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist">
<li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-2-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-1" role="tab" aria-controls="tabset-2-1" aria-selected="true">DuckDB</a></li>
<li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-2" role="tab" aria-controls="tabset-2-2" aria-selected="false">SAS</a></li>
</ul>
<div class="tab-content">
<div id="tabset-2-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-2-1-tab">
<div class="cell" data-tbl-label="tbl-dem-l3-agecat-catvars-duckdb">
<table class="table table-sm table-striped small">
<thead><tr class="header">
<th>agecat_years</th>
<th>count</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>08. 25-34 yrs</td>
<td>24747</td>
</tr>
<tr class="even">
<td>09. 35-44 yrs</td>
<td>49660</td>
</tr>
<tr class="odd">
<td>10. 45-54 yrs</td>
<td>100906</td>
</tr>
<tr class="even">
<td>11. 55-59 yrs</td>
<td>70964</td>
</tr>
<tr class="odd">
<td>12. 60-64 yrs</td>
<td>80540</td>
</tr>
<tr class="even">
<td>13. 65-69 yrs</td>
<td>342196</td>
</tr>
<tr class="odd">
<td>14. 70-74 yrs</td>
<td>460971</td>
</tr>
<tr class="even">
<td>15. 75+</td>
<td>1094755</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="tabset-2-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-2-tab">
<pre><code>Obs    agecat_years                count

1     08. 25-34 yrs              24,747
2     09. 35-44 yrs              49,660
3     10. 45-54 yrs             100,906
4     11. 55-59 yrs              70,964
5     12. 60-64 yrs              80,540
6     13. 65-69 yrs             342,196
7     14. 70-74 yrs             460,971
8     15. 75+ yrs             1,094,755</code></pre>
</div>
</div>
</div>
<p>Let’s try something a little more cursed. <a href="#lst-dx-per-enc-per-pat" class="quarto-xref">Listing&nbsp;4</a> shows a query which attempts to calculate the number of diagnoses per Encounter per Patient. It’s going to output 111706063 rows, so I’m not going to bother printing results, just the runtime.</p>
<div class="cell">
<div id="lst-dx-per-enc-per-pat" class="bash cell-code listing quarto-float">
<figure class="quarto-float quarto-float-lst figure"><figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-lst" id="lst-dx-per-enc-per-pat-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Listing&nbsp;4: Runtime for a query that tries to join the diagnosis table to the encounter table by PatID and EncounterID and counts the number of diagnosis by PatID and EncounterID
</figcaption><div aria-describedby="lst-dx-per-enc-per-pat-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="sourceCode cell-code" id="lst-dx-per-enc-per-pat"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="lst-dx-per-enc-per-pat-1"><a href="#lst-dx-per-enc-per-pat-1" aria-hidden="true" tabindex="-1"></a><span class="bu">time</span> /opt/homebrew/bin/duckdb duckdb.duckdb <span class="at">-c</span> <span class="st">"</span></span>
<span id="lst-dx-per-enc-per-pat-2"><a href="#lst-dx-per-enc-per-pat-2" aria-hidden="true" tabindex="-1"></a><span class="st">  CREATE OR REPLACE TEMP TABLE dia_l2_enc_patid AS</span></span>
<span id="lst-dx-per-enc-per-pat-3"><a href="#lst-dx-per-enc-per-pat-3" aria-hidden="true" tabindex="-1"></a><span class="st">  SELECT a.PatID</span></span>
<span id="lst-dx-per-enc-per-pat-4"><a href="#lst-dx-per-enc-per-pat-4" aria-hidden="true" tabindex="-1"></a><span class="st">       , a.EncounterID</span></span>
<span id="lst-dx-per-enc-per-pat-5"><a href="#lst-dx-per-enc-per-pat-5" aria-hidden="true" tabindex="-1"></a><span class="st">       , count(b.DX) as count </span></span>
<span id="lst-dx-per-enc-per-pat-6"><a href="#lst-dx-per-enc-per-pat-6" aria-hidden="true" tabindex="-1"></a><span class="st">  FROM '~/dev/SynPUFsDuckDB/data/encounter-snappy.parquet' as a </span></span>
<span id="lst-dx-per-enc-per-pat-7"><a href="#lst-dx-per-enc-per-pat-7" aria-hidden="true" tabindex="-1"></a><span class="st">  JOIN '~/dev/SynPUFsDuckDB/data/diagnosis-snappy.parquet' as b </span></span>
<span id="lst-dx-per-enc-per-pat-8"><a href="#lst-dx-per-enc-per-pat-8" aria-hidden="true" tabindex="-1"></a><span class="st">  ON (a.PatID = b.PatID and a.EncounterID = b.EncounterID) </span></span>
<span id="lst-dx-per-enc-per-pat-9"><a href="#lst-dx-per-enc-per-pat-9" aria-hidden="true" tabindex="-1"></a><span class="st">  GROUP BY a.EncounterID, a.PatID;"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</figure>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
real    0m12.780s
user    0m50.538s
sys 0m12.321s</code></pre>
</div>
</div>
<p>Each time I run this query, it takes between 35 and 50 seconds. I gave up on SAS after about 45 minutes.</p>
</section><section id="what-about-r" class="level2"><h2 class="anchored" data-anchor-id="what-about-r">What about R?</h2>
<p>There are a number of methods for running a query and returning an R object. They deserve their own post, and so I’ll write about these soon.</p>


</section><div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>
<ol>
<li id="fn1"><p>A better solution would have been to use SAS to convert the SynPUF data from the SAS7BDAT format to JSON or CSV, however, I don’t have a SAS license for my personal machine, my work laptop doesn’t have the hard drive space left to hold it, and it VPN and bandwidth constraints would have made it challenging to remove from my work environment.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol></section></div></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/musings\.mountainherder\.xyz");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions"><ul><li><a href="https://github.com/scarnecchia/musings/issues" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li><li><a href="https://github.com/scarnecchia/musings/blob/main/_site/posts/2024-04-03_duckdb-r-sentinel-data/index.qmd" class="toc-action"><i class="bi empty"></i>View source</a></li></ul></div></div></div></footer></body></html>